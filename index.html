<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kintoneé€šçŸ¥è¨­å®šç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .sync-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .managers-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .managers-input input {
            flex: 1;
        }
        
        .manager-tag {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            font-size: 12px;
        }
        
        .manager-tag .remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .employee-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .employee-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .employee-info {
            flex: 1;
            min-width: 200px;
        }
        
        .employee-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .employee-managers {
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .employee-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .code-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .sync-status {
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”” kintoneé€šçŸ¥è¨­å®šç®¡ç†</h1>
            <p>ãƒãƒ¼ãƒ å…±åŒã§è¨­å®šã‚’ç®¡ç†ã§ãã¾ã™</p>
            <div class="sync-controls">
                <button class="btn btn-primary" onclick="loadFromCloud()">â˜ï¸ æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
                <button class="btn btn-success" onclick="saveToCloud()">ğŸ’¾ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜</button>
            </div>
            <div class="sync-status" id="syncStatus">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>
        </div>
        
        <div class="content">
            <div id="statusMessage" class="status-message"></div>
            
            <!-- ç¤¾å“¡è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ‘¥ ç¤¾å“¡åˆ¥é€šçŸ¥è¨­å®š</h2>
                
                <div class="form-group">
                    <label for="employeeName">ç¤¾å“¡å</label>
                    <input type="text" id="employeeName" placeholder="ä¾‹: ä½è—¤ç¾ä¹Ÿ">
                </div>
                
                <div class="form-group">
                    <label for="managerAccount">æ‹…å½“è€…Lineworksã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</label>
                    <div class="managers-input">
                        <input type="text" id="managerAccount" placeholder="ä¾‹: manager@company.com">
                        <button class="btn btn-primary" onclick="addManager()">è¿½åŠ </button>
                    </div>
                    <div id="managersList"></div>
                </div>
                
                <button class="btn btn-success" onclick="addEmployee()">ç¤¾å“¡ã‚’è¿½åŠ </button>
                
                <div class="employee-list">
                    <h3>ç¾åœ¨ã®è¨­å®š</h3>
                    <div id="employeeItems">è¨­å®šã•ã‚ŒãŸç¤¾å“¡ãŒã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            </div>
            
            <!-- åŸºæœ¬è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>âš™ï¸ åŸºæœ¬è¨­å®š</h2>
                
                <div class="form-group">
                    <label for="clientId">Client ID</label>
                    <input type="text" id="clientId" value="KQAmuJg7WB3xxNWxdkFw">
                </div>
                
                <div class="form-group">
                    <label for="botNo">Botç•ªå·</label>
                    <input type="text" id="botNo" value="6806964">
                </div>
                
                <div class="form-group">
                    <label for="gasUrl">GAS Web App URL</label>
                    <input type="text" id="gasUrl" value="https://script.google.com/macros/s/AKfycbxiqTtqhFjTW-5Q0et2taPyhfGCHD_ex6YVrXLbE9i3c9K-yGJatO5SguXOHzmjAHCq8g/exec">
                </div>
                
                <div class="form-group">
                    <label for="defaultAccount">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€šçŸ¥å…ˆ</label>
                    <input type="text" id="defaultAccount" value="judusgrazyex@spintechnologycoltd">
                </div>
                
                <button class="btn btn-success" onclick="saveBasicSettings()">åŸºæœ¬è¨­å®šã‚’ä¿å­˜</button>
            </div>
            
            <!-- ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“ JavaScriptã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</h2>
                
                <p style="margin-bottom: 20px; color: #6c757d;">
                    è¨­å®šå®Œäº†å¾Œã€ä¸‹è¨˜ãƒœã‚¿ãƒ³ã§kintoneç”¨ã®JavaScriptã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚
                </p>
                
                <button class="btn btn-primary" onclick="generateCode()">ğŸ”„ ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ</button>
                <button class="btn btn-success" onclick="copyCode()">ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
                
                <div id="generatedCode" class="code-output" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨
        let employeeSettings = {};
        let basicSettings = {
            clientId: 'KQAmuJg7WB3xxNWxdkFw',
            botNo: '6806964',
            gasUrl: 'https://script.google.com/macros/s/AKfycbxiqTtqhFjTW-5Q0et2taPyhfGCHD_ex6YVrXLbE9i3c9K-yGJatO5SguXOHzmjAHCq8g/exec',
            defaultAccount: 'judusgrazyex@spintechnologycoltd'
        };
        let currentManagers = [];

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateSyncStatus(message) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.textContent = message;
        }

        // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆCORSãƒ—ãƒ­ã‚­ã‚·ä½¿ç”¨ï¼‰
        function loadFromCloud() {
            updateSyncStatus('ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...');
            
            const gasUrl = document.getElementById('gasUrl').value;
            if (!gasUrl) {
                showMessage('GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            // AllOrigins CORSãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(gasUrl + '?action=getSettings')}`;
            
            fetch(proxyUrl)
                .then(response => response.json())
                .then(proxyData => {
                    const data = JSON.parse(proxyData.contents);
                    
                    if (data.success) {
                        employeeSettings = data.employeeSettings || {};
                        updateEmployeeList();
                        
                        const count = Object.keys(employeeSettings).length;
                        updateSyncStatus(`âœ… å–å¾—å®Œäº† (${count}äºº)`);
                        showMessage(`ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸï¼ˆ${count}äººï¼‰`, 'success');
                    } else {
                        updateSyncStatus('âŒ å–å¾—å¤±æ•—');
                        showMessage('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
                    }
                })
                .catch(error => {
                    updateSyncStatus('âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼');
                    showMessage('æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚GAS URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                    console.error('Error:', error);
                });
        }

        // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆCORSãƒ—ãƒ­ã‚­ã‚·ä½¿ç”¨ï¼‰
        function saveToCloud() {
            updateSyncStatus('ä¿å­˜ä¸­...');
            
            const gasUrl = document.getElementById('gasUrl').value;
            if (!gasUrl) {
                showMessage('GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            const updaterName = prompt('æ›´æ–°è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:') || 'Unknown User';
            
            const postData = {
                action: 'saveSettings',
                employeeSettings: employeeSettings,
                basicSettings: basicSettings,
                lastUpdated: new Date().toISOString(),
                lastUpdatedBy: updaterName
            };

            // AllOrigins CORSãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ï¼ˆPOSTå¯¾å¿œï¼‰
            fetch('https://api.allorigins.win/raw', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    method: 'POST',
                    url: gasUrl,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const count = Object.keys(employeeSettings).length;
                    updateSyncStatus(`âœ… ä¿å­˜å®Œäº† (${count}äºº)`);
                    showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                } else {
                    updateSyncStatus('âŒ ä¿å­˜å¤±æ•—');
                    showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
                }
            })
            .catch(error => {
                updateSyncStatus('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼');
                showMessage('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                console.error('Error:', error);
            });
        }

        // æ‹…å½“è€…ã‚’è¿½åŠ 
        function addManager() {
            const managerInput = document.getElementById('managerAccount');
            const manager = managerInput.value.trim();
            
            if (manager && !currentManagers.includes(manager)) {
                currentManagers.push(manager);
                updateManagersList();
                managerInput.value = '';
            }
        }

        // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateManagersList() {
            const managersList = document.getElementById('managersList');
            managersList.innerHTML = currentManagers.map(manager => 
                `<span class="manager-tag">${manager} <span class="remove" onclick="removeManager('${manager}')">Ã—</span></span>`
            ).join('');
        }

        // æ‹…å½“è€…ã‚’å‰Šé™¤
        function removeManager(manager) {
            currentManagers = currentManagers.filter(m => m !== manager);
            updateManagersList();
        }

        // ç¤¾å“¡ã‚’è¿½åŠ 
        function addEmployee() {
            const employeeName = document.getElementById('employeeName').value.trim();
            
            if (!employeeName) {
                showMessage('ç¤¾å“¡åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (currentManagers.length === 0) {
                showMessage('æ‹…å½“è€…ã‚’å°‘ãªãã¨ã‚‚1äººè¿½åŠ ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (employeeSettings[employeeName]) {
                const overwrite = confirm(`${employeeName}ã®è¨­å®šãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`);
                if (!overwrite) {
                    return;
                }
            }
            
            employeeSettings[employeeName] = [...currentManagers];
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('employeeName').value = '';
            currentManagers = [];
            updateManagersList();
            
            // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            updateEmployeeList();
            
            showMessage(`${employeeName}ã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
        }

        // ç¤¾å“¡ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateEmployeeList() {
            const employeeItems = document.getElementById('employeeItems');
            
            if (Object.keys(employeeSettings).length === 0) {
                employeeItems.innerHTML = '<p style="text-align: center; color: #7f8c8d;">è¨­å®šã•ã‚ŒãŸç¤¾å“¡ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            employeeItems.innerHTML = Object.entries(employeeSettings).map(([name, managers]) => `
                <div class="employee-item">
                    <div class="employee-info">
                        <div class="employee-name">ğŸ‘¤ ${name}</div>
                        <div class="employee-managers">ğŸ“§ ${managers.join(', ')}</div>
                    </div>
                    <div class="employee-actions">
                        <button class="btn btn-danger" onclick="removeEmployee('${name}')">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // ç¤¾å“¡ã‚’å‰Šé™¤
        function removeEmployee(name) {
            if (confirm(`${name}ã®è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                delete employeeSettings[name];
                updateEmployeeList();
                showMessage(`${name}ã®è¨­å®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'info');
            }
        }

        // åŸºæœ¬è¨­å®šã‚’ä¿å­˜
        function saveBasicSettings() {
            basicSettings.clientId = document.getElementById('clientId').value;
            basicSettings.botNo = document.getElementById('botNo').value;
            basicSettings.gasUrl = document.getElementById('gasUrl').value;
            basicSettings.defaultAccount = document.getElementById('defaultAccount').value;
            
            showMessage('åŸºæœ¬è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }

        // ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        function generateCode() {
            if (Object.keys(employeeSettings).length === 0) {
                showMessage('ã¾ãšç¤¾å“¡è¨­å®šã‚’è¿½åŠ ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const mappingCode = Object.entries(employeeSettings)
                .map(([name, managers]) => `        '${name}': [${managers.map(m => `'${m}'`).join(', ')}]`)
                .join(',\n');
            
            const code = `(function() {
    'use strict';
    
    // åŸºæœ¬è¨­å®šå€¤
    const CLIENT_ID = '${basicSettings.clientId}';
    const BOT_NO = '${basicSettings.botNo}';
    const GAS_WEB_APP_URL = '${basicSettings.gasUrl}';
    
    // ç¤¾å“¡åã¨æ‹…å½“è€…ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const EMPLOYEE_MANAGER_MAPPING = {
${mappingCode},
        'DEFAULT': ['${basicSettings.defaultAccount}']
    };
    
    // kintoneãƒ¬ã‚³ãƒ¼ãƒ‰ä¿å­˜æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    kintone.events.on([
        'app.record.create.submit.success', 
        'app.record.edit.submit.success'
    ], function(event) {
        
        const record = event.record;
        const appId = kintone.app.getId();
        const recordId = event.recordId;
        const appName = kintone.app.getName();
        const updatedBy = kintone.getLoginUser();
        const updaterName = updatedBy.name;
        
        // åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’å–å¾—
        const employeeName = record['åå‰'] ? record['åå‰'].value : '';
        
        if (!employeeName) {
            console.log('åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç©ºã®ãŸã‚ã€é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚');
            return event;
        }
        
        // æ‹…å½“è€…ã‚’æ±ºå®š
        const recipients = EMPLOYEE_MANAGER_MAPPING[employeeName] || EMPLOYEE_MANAGER_MAPPING['DEFAULT'];
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
        let message = \`ğŸ“‹ ç¤¾å“¡ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ\\n\\n\`;
        message += \`ğŸ·ï¸ ã‚¢ãƒ—ãƒªå: \${appName}\\n\`;
        message += \`ğŸ‘¤ æ›´æ–°ã•ã‚ŒãŸç¤¾å“¡: \${employeeName}\\n\`;
        message += \`âœï¸ æ›´æ–°è€…: \${updaterName}\\n\`;
        message += \`ğŸ†” ãƒ¬ã‚³ãƒ¼ãƒ‰ID: \${recordId}\\n\`;
        message += \`ğŸ• æ›´æ–°æ—¥æ™‚: \${new Date().toLocaleString('ja-JP')}\\n\`;
        
        if (record['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']) {
            message += \`ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: \${record['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'].value}\\n\`;
        }
        
        message += \`\\nğŸ”— ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª: \${location.origin}/k/\${appId}/show#record=\${recordId}\`;
        
        // é€šçŸ¥é€ä¿¡
        getAccessTokenAndSend(message, recipients);
        
        return event;
    });
    
    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦é€šçŸ¥é€ä¿¡
    function getAccessTokenAndSend(message, recipients) {
        kintone.proxy(GAS_WEB_APP_URL, 'GET', {})
        .then(function(response) {
            try {
                const data = JSON.parse(response[0]);
                if (data.access_token) {
                    sendToMultipleRecipients(message, data.access_token, recipients);
                }
            } catch (error) {
                console.error('ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        })
        .catch(function(error) {
            console.error('GASå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
        });
    }
    
    // è¤‡æ•°ã®å—ä¿¡è€…ã«é€šçŸ¥é€ä¿¡
    function sendToMultipleRecipients(message, accessToken, recipients) {
        const url = \`https://apis.worksmobile.com/r/\${CLIENT_ID}/message/v1/bot/\${BOT_NO}/message/push\`;
        const uniqueRecipients = [...new Set(recipients)];
        
        uniqueRecipients.forEach((accountId, index) => {
            const data = {
                accountId: accountId,
                content: {
                    type: 'text',
                    text: message
                }
            };
            
            const headers = {
                'Authorization': \`Bearer \${accessToken}\`,
                'Content-Type': 'application/json'
            };
            
            setTimeout(() => {
                kintone.proxy(url, 'POST', headers, JSON.stringify(data))
                .then(function(response) {
                    console.log(\`\${accountId} ã¸ã®é€šçŸ¥é€ä¿¡æˆåŠŸ\`);
                })
                .catch(function(error) {
                    console.error(\`\${accountId} ã¸ã®é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:\`, error);
                });
            }, index * 300);
        });
    }
    
})();`;
            
            const codeElement = document.getElementById('generatedCode');
            codeElement.textContent = code;
            codeElement.style.display = 'block';
            
            showMessage('ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
        }

        // ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
        function copyCode() {
            const codeElement = document.getElementById('generatedCode');
            
            if (!codeElement.textContent) {
                showMessage('ã¾ãšã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            navigator.clipboard.writeText(codeElement.textContent).then(() => {
                showMessage('ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
            }).catch(() => {
                showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            });
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateEmployeeList();
            // åˆå›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            setTimeout(() => {
                loadFromCloud();
            }, 1000);
        });
    </script>
</body>
</html>
