<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kintone通知設定管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .sync-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .managers-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .managers-input input {
            flex: 1;
        }
        
        .manager-tag {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            font-size: 12px;
        }
        
        .manager-tag .remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .employee-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .employee-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .employee-info {
            flex: 1;
            min-width: 200px;
        }
        
        .employee-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .employee-managers {
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .employee-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .code-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .sync-status {
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔔 kintone通知設定管理</h1>
            <p>チーム共同で設定を管理できます</p>
            <div class="sync-controls">
                <button class="btn btn-primary" onclick="loadFromCloud()">☁️ 最新データを取得</button>
                <button class="btn btn-success" onclick="saveToCloud()">💾 クラウドに保存</button>
            </div>
            <div class="sync-status" id="syncStatus">データ取得中...</div>
        </div>
        
        <div class="content">
            <div id="statusMessage" class="status-message"></div>
            
            <!-- 社員設定セクション -->
            <div class="section">
                <h2>👥 社員別通知設定</h2>
                
                <div class="form-group">
                    <label for="employeeName">社員名</label>
                    <input type="text" id="employeeName" placeholder="例: 佐藤美也">
                </div>
                
                <div class="form-group">
                    <label for="managerAccount">担当者Lineworksアカウント</label>
                    <div class="managers-input">
                        <input type="text" id="managerAccount" placeholder="例: manager@company.com">
                        <button class="btn btn-primary" onclick="addManager()">追加</button>
                    </div>
                    <div id="managersList"></div>
                </div>
                
                <button class="btn btn-success" onclick="addEmployee()">社員を追加</button>
                
                <div class="employee-list">
                    <h3>現在の設定</h3>
                    <div id="employeeItems">設定された社員がありません</div>
                </div>
            </div>
            
            <!-- 基本設定セクション -->
            <div class="section">
                <h2>⚙️ 基本設定</h2>
                
                <div class="form-group">
                    <label for="clientId">Client ID</label>
                    <input type="text" id="clientId" value="KQAmuJg7WB3xxNWxdkFw">
                </div>
                
                <div class="form-group">
                    <label for="botNo">Bot番号</label>
                    <input type="text" id="botNo" value="6806964">
                </div>
                
                <div class="form-group">
                    <label for="gasUrl">GAS Web App URL</label>
                    <input type="text" id="gasUrl" value="https://script.google.com/macros/s/AKfycbxiqTtqhFjTW-5Q0et2taPyhfGCHD_ex6YVrXLbE9i3c9K-yGJatO5SguXOHzmjAHCq8g/exec">
                </div>
                
                <div class="form-group">
                    <label for="defaultAccount">デフォルト通知先</label>
                    <input type="text" id="defaultAccount" value="judusgrazyex@spintechnologycoltd">
                </div>
                
                <button class="btn btn-success" onclick="saveBasicSettings()">基本設定を保存</button>
            </div>
            
            <!-- コード生成セクション -->
            <div class="section">
                <h2>📝 JavaScriptコード生成</h2>
                
                <p style="margin-bottom: 20px; color: #6c757d;">
                    設定完了後、下記ボタンでkintone用のJavaScriptコードを生成できます。
                </p>
                
                <button class="btn btn-primary" onclick="generateCode()">🔄 コードを生成</button>
                <button class="btn btn-success" onclick="copyCode()">📋 コードをコピー</button>
                
                <div id="generatedCode" class="code-output" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // データ保存用
        let employeeSettings = {};
        let basicSettings = {
            clientId: 'KQAmuJg7WB3xxNWxdkFw',
            botNo: '6806964',
            gasUrl: 'https://script.google.com/macros/s/AKfycbxiqTtqhFjTW-5Q0et2taPyhfGCHD_ex6YVrXLbE9i3c9K-yGJatO5SguXOHzmjAHCq8g/exec',
            defaultAccount: 'judusgrazyex@spintechnologycoltd'
        };
        let currentManagers = [];

        // メッセージ表示
        function showMessage(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // 同期ステータス更新
        function updateSyncStatus(message) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.textContent = message;
        }

        // クラウドからデータを取得（CORSプロキシ使用）
        function loadFromCloud() {
            updateSyncStatus('データ取得中...');
            
            const gasUrl = document.getElementById('gasUrl').value;
            if (!gasUrl) {
                showMessage('GAS URLが設定されていません', 'error');
                return;
            }
            
            // AllOrigins CORSプロキシを使用
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(gasUrl + '?action=getSettings')}`;
            
            fetch(proxyUrl)
                .then(response => response.json())
                .then(proxyData => {
                    const data = JSON.parse(proxyData.contents);
                    
                    if (data.success) {
                        employeeSettings = data.employeeSettings || {};
                        updateEmployeeList();
                        
                        const count = Object.keys(employeeSettings).length;
                        updateSyncStatus(`✅ 取得完了 (${count}人)`);
                        showMessage(`データを取得しました（${count}人）`, 'success');
                    } else {
                        updateSyncStatus('❌ 取得失敗');
                        showMessage('データ取得に失敗しました: ' + (data.error || '不明なエラー'), 'error');
                    }
                })
                .catch(error => {
                    updateSyncStatus('❌ 接続エラー');
                    showMessage('接続エラーが発生しました。GAS URLを確認してください。', 'error');
                    console.error('Error:', error);
                });
        }

        // クラウドにデータを保存（CORSプロキシ使用）
        function saveToCloud() {
            updateSyncStatus('保存中...');
            
            const gasUrl = document.getElementById('gasUrl').value;
            if (!gasUrl) {
                showMessage('GAS URLが設定されていません', 'error');
                return;
            }

            const updaterName = prompt('更新者名を入力してください:') || 'Unknown User';
            
            const postData = {
                action: 'saveSettings',
                employeeSettings: employeeSettings,
                basicSettings: basicSettings,
                lastUpdated: new Date().toISOString(),
                lastUpdatedBy: updaterName
            };

            // AllOrigins CORSプロキシを使用（POST対応）
            fetch('https://api.allorigins.win/raw', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    method: 'POST',
                    url: gasUrl,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const count = Object.keys(employeeSettings).length;
                    updateSyncStatus(`✅ 保存完了 (${count}人)`);
                    showMessage('データを保存しました', 'success');
                } else {
                    updateSyncStatus('❌ 保存失敗');
                    showMessage('保存に失敗しました: ' + (result.error || '不明なエラー'), 'error');
                }
            })
            .catch(error => {
                updateSyncStatus('❌ 保存エラー');
                showMessage('保存中にエラーが発生しました', 'error');
                console.error('Error:', error);
            });
        }

        // 担当者を追加
        function addManager() {
            const managerInput = document.getElementById('managerAccount');
            const manager = managerInput.value.trim();
            
            if (manager && !currentManagers.includes(manager)) {
                currentManagers.push(manager);
                updateManagersList();
                managerInput.value = '';
            }
        }

        // 担当者リストを更新
        function updateManagersList() {
            const managersList = document.getElementById('managersList');
            managersList.innerHTML = currentManagers.map(manager => 
                `<span class="manager-tag">${manager} <span class="remove" onclick="removeManager('${manager}')">×</span></span>`
            ).join('');
        }

        // 担当者を削除
        function removeManager(manager) {
            currentManagers = currentManagers.filter(m => m !== manager);
            updateManagersList();
        }

        // 社員を追加
        function addEmployee() {
            const employeeName = document.getElementById('employeeName').value.trim();
            
            if (!employeeName) {
                showMessage('社員名を入力してください', 'error');
                return;
            }
            
            if (currentManagers.length === 0) {
                showMessage('担当者を少なくとも1人追加してください', 'error');
                return;
            }
            
            // 重複チェック
            if (employeeSettings[employeeName]) {
                const overwrite = confirm(`${employeeName}の設定が既に存在します。上書きしますか？`);
                if (!overwrite) {
                    return;
                }
            }
            
            employeeSettings[employeeName] = [...currentManagers];
            
            // フォームをリセット
            document.getElementById('employeeName').value = '';
            currentManagers = [];
            updateManagersList();
            
            // リストを更新
            updateEmployeeList();
            
            showMessage(`${employeeName}の設定を追加しました`, 'success');
        }

        // 社員リストを更新
        function updateEmployeeList() {
            const employeeItems = document.getElementById('employeeItems');
            
            if (Object.keys(employeeSettings).length === 0) {
                employeeItems.innerHTML = '<p style="text-align: center; color: #7f8c8d;">設定された社員がありません</p>';
                return;
            }
            
            employeeItems.innerHTML = Object.entries(employeeSettings).map(([name, managers]) => `
                <div class="employee-item">
                    <div class="employee-info">
                        <div class="employee-name">👤 ${name}</div>
                        <div class="employee-managers">📧 ${managers.join(', ')}</div>
                    </div>
                    <div class="employee-actions">
                        <button class="btn btn-danger" onclick="removeEmployee('${name}')">削除</button>
                    </div>
                </div>
            `).join('');
        }

        // 社員を削除
        function removeEmployee(name) {
            if (confirm(`${name}の設定を削除しますか？`)) {
                delete employeeSettings[name];
                updateEmployeeList();
                showMessage(`${name}の設定を削除しました`, 'info');
            }
        }

        // 基本設定を保存
        function saveBasicSettings() {
            basicSettings.clientId = document.getElementById('clientId').value;
            basicSettings.botNo = document.getElementById('botNo').value;
            basicSettings.gasUrl = document.getElementById('gasUrl').value;
            basicSettings.defaultAccount = document.getElementById('defaultAccount').value;
            
            showMessage('基本設定を保存しました', 'success');
        }

        // コードを生成
        function generateCode() {
            if (Object.keys(employeeSettings).length === 0) {
                showMessage('まず社員設定を追加してください', 'error');
                return;
            }
            
            const mappingCode = Object.entries(employeeSettings)
                .map(([name, managers]) => `        '${name}': [${managers.map(m => `'${m}'`).join(', ')}]`)
                .join(',\n');
            
            const code = `(function() {
    'use strict';
    
    // 基本設定値
    const CLIENT_ID = '${basicSettings.clientId}';
    const BOT_NO = '${basicSettings.botNo}';
    const GAS_WEB_APP_URL = '${basicSettings.gasUrl}';
    
    // 社員名と担当者のマッピング
    const EMPLOYEE_MANAGER_MAPPING = {
${mappingCode},
        'DEFAULT': ['${basicSettings.defaultAccount}']
    };
    
    // kintoneレコード保存時のイベント
    kintone.events.on([
        'app.record.create.submit.success', 
        'app.record.edit.submit.success'
    ], function(event) {
        
        const record = event.record;
        const appId = kintone.app.getId();
        const recordId = event.recordId;
        const appName = kintone.app.getName();
        const updatedBy = kintone.getLoginUser();
        const updaterName = updatedBy.name;
        
        // 名前フィールドの値を取得
        const employeeName = record['名前'] ? record['名前'].value : '';
        
        if (!employeeName) {
            console.log('名前フィールドが空のため、通知をスキップします。');
            return event;
        }
        
        // 担当者を決定
        const recipients = EMPLOYEE_MANAGER_MAPPING[employeeName] || EMPLOYEE_MANAGER_MAPPING['DEFAULT'];
        
        // メッセージを作成
        let message = \`📋 社員レコードが更新されました\\n\\n\`;
        message += \`🏷️ アプリ名: \${appName}\\n\`;
        message += \`👤 更新された社員: \${employeeName}\\n\`;
        message += \`✏️ 更新者: \${updaterName}\\n\`;
        message += \`🆔 レコードID: \${recordId}\\n\`;
        message += \`🕐 更新日時: \${new Date().toLocaleString('ja-JP')}\\n\`;
        
        if (record['ステータス']) {
            message += \`📊 ステータス: \${record['ステータス'].value}\\n\`;
        }
        
        message += \`\\n🔗 レコードを確認: \${location.origin}/k/\${appId}/show#record=\${recordId}\`;
        
        // 通知送信
        getAccessTokenAndSend(message, recipients);
        
        return event;
    });
    
    // アクセストークンを取得して通知送信
    function getAccessTokenAndSend(message, recipients) {
        kintone.proxy(GAS_WEB_APP_URL, 'GET', {})
        .then(function(response) {
            try {
                const data = JSON.parse(response[0]);
                if (data.access_token) {
                    sendToMultipleRecipients(message, data.access_token, recipients);
                }
            } catch (error) {
                console.error('アクセストークン取得エラー:', error);
            }
        })
        .catch(function(error) {
            console.error('GAS呼び出しエラー:', error);
        });
    }
    
    // 複数の受信者に通知送信
    function sendToMultipleRecipients(message, accessToken, recipients) {
        const url = \`https://apis.worksmobile.com/r/\${CLIENT_ID}/message/v1/bot/\${BOT_NO}/message/push\`;
        const uniqueRecipients = [...new Set(recipients)];
        
        uniqueRecipients.forEach((accountId, index) => {
            const data = {
                accountId: accountId,
                content: {
                    type: 'text',
                    text: message
                }
            };
            
            const headers = {
                'Authorization': \`Bearer \${accessToken}\`,
                'Content-Type': 'application/json'
            };
            
            setTimeout(() => {
                kintone.proxy(url, 'POST', headers, JSON.stringify(data))
                .then(function(response) {
                    console.log(\`\${accountId} への通知送信成功\`);
                })
                .catch(function(error) {
                    console.error(\`\${accountId} への通知送信エラー:\`, error);
                });
            }, index * 300);
        });
    }
    
})();`;
            
            const codeElement = document.getElementById('generatedCode');
            codeElement.textContent = code;
            codeElement.style.display = 'block';
            
            showMessage('コードを生成しました', 'success');
        }

        // コードをコピー
        function copyCode() {
            const codeElement = document.getElementById('generatedCode');
            
            if (!codeElement.textContent) {
                showMessage('まずコードを生成してください', 'error');
                return;
            }
            
            navigator.clipboard.writeText(codeElement.textContent).then(() => {
                showMessage('コードをクリップボードにコピーしました', 'success');
            }).catch(() => {
                showMessage('コピーに失敗しました', 'error');
            });
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            updateEmployeeList();
            // 初回データ読み込み
            setTimeout(() => {
                loadFromCloud();
            }, 1000);
        });
    </script>
</body>
</html>
